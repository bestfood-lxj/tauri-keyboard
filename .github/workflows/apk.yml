name: Build Apk test
on:
  workflow_dispatch:
jobs:
  apk:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Qwerty and Typewords build
        if: $${{ env.ANDROID_FLUTTER_VERSION == '3.13.9' }}
        run: |
          mkdir .tmp
          cd .tmp
          git clone https://github.com/bestfood-lxj/qwerty-learner.git
          cd qwerty-learner
          npm install
          rm -fr build
          rm -fr qwerty
          rm -fr qwerty-learner
          npm run build
          mv build qwerty-learner
          mkdir qwerty
          mv qwerty-learner qwerty
          rm -fr ../../src/assets/qwerty
          mv qwerty ../../src/assets/
          cd ..
          git clone https://github.com/bestfood-lxj/TypeWords.git
          cd TypeWords
          rm -fr dist
          rm -fr typewords
          npm install
          npm run build
          mv dist typewords
          rm -fr ../../src/assets/typewords
          cp -r typewords ../../src/assets/.
      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          workspaces: ./src-tauri -> target
      - name: install dependencies
        run: |
          sudo apt-get update
          #sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
          sudo apt-get install -y libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev
        # webkitgtk 4.0 is for Tauri v1 - webkitgtk 4.1 is for Tauri v2.
        # You can remove the one that doesn't apply to your app to speed up the workflow a bit.
        # add the Android targets with rustup:
      - name: build apk
        run: |
          cargo install create-tauri-app --locked
          cargo install tauri-cli
          rustup target add aarch64-linux-android
          cd src-tauri
          cargo clean
          cd ..
          cargo tauri android build  -t aarch64
          echo "$JKSFILE" | base64 --decode > my-release-key.jks
          #$ANDROID_SDK/build-tools/35.0.0/apksigner sign --ks my-release-key.jks --ks-key-alias "$JKS_ALIAS" --ks-pass "$JKS_PASS" --out app-universal-release-signed.apk app-universal-release-unsigned.apk
          /usr/local/lib/android/sdk/build-tools/35.0.0/apksigner sign --ks my-release-key.jks --ks-key-alias "$JKS_ALIAS" --ks-pass "pass:$JKS_PASS" --out src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release-signed.apk src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release-unsigned.apk
        env:
          JKSFILE: ${{ secrets.JKSFILE }}
          JKS_ALIAS: ${{ secrets.JKS_ALIAS }}
          JKS_PASS: ${{ secrets.JKS_PASS }}
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          # download auto zip
          name: signed-release
          path: |
            src-tauri/gen/android/app/build/outputs/apk/universal/release/*-signed.apk
